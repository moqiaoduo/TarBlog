"use strict";var upload={renderSize:function(t){if(null==t||""===t)return"0 Bytes";var e=parseFloat(t),n=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,n)).toFixed(2)+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][n]},transfer:function(t,e){var n=new FormData,i=upload.uuid();if(t){var a=$("meta[name='allow-ext']").attr("content").split("|"),o=t.name,r=o.substring(o.lastIndexOf(".")+1);if(-1===a.indexOf(r))return void alert("不支持该类型文件上传");$("#file-list").append('<li id="attachment-'.concat(i,'"><div>').concat(o,'</div>\n    <div class="info">').concat(upload.renderSize(t.size),' <img src="assets/img/ajax-loader.gif" class="upload-loading"></div></li>')),n.append("file",t)}else for(var s in n.append("skipUpload",1),e)n.append(s,e[s]);$.ajax({url:"do.php?a=Admin/Attachment/Upload",type:"post",cache:!1,context:document.getElementById("attachment-"+i),data:n,contentType:!1,processData:!1,dataType:"json",error:function(){alert("上传失败，请重试"),$(this).remove()},success:function(t){var e;t.success?(e="image"===t.type?"image-l":"file-l",$(this).html('\n                    <i class="czs-'.concat(e,'"></i>\n                    <a class="insert-file ').concat(t.type,'" href="javascript:;" title="点击插入文件">').concat(t.name,'</a>\n                    <input type="hidden" class="attachment-url" value="').concat(t.url,'">\n                    <div class="info">\n                        ').concat(t.size,'\n                        <a class="file" target="_blank" href="media-editor.php?cid=').concat(t.id,'" title="编辑">\n                            <i class="czs-pen"></i>\n                        </a>\n                        <a class="file" href="javascript:;" title="删除"><i class="czs-trash-l"></i></a>\n                        <input type="hidden" name="attachment[]" class="attachment-id" value="').concat(t.id,'">\n                    </div>')).attr("id","attachment-"+t.id)):(alert("上传失败，错误信息："+t.msg),$(this).remove())}})},process:function(t){for(var e=0;e<t.length;e++){var n=t[e];n&&upload.transfer(n)}},uuid:function(){for(var t=[],e="0123456789abcdef",n=0;n<36;n++)t[n]=e.substr(Math.floor(16*Math.random()),1);return t[14]="4",t[19]=e.substr(3&t[19]|8,1),t[8]=t[13]=t[18]=t[23]="-",t.join("")}};$(function(){var e=$("#tag"),n=null,t=$("#file-select"),i=document.getElementsByClassName("upload-area").item(0),a=$("#insert-link-form"),o=$("#insert-pic-form"),r=$('.post-form :input[name!="content"]').serialize();function s(t){e.val(""),$("#tag-input-dropdown").html(""),0===$('input[name="tag[]"][value="'+t+'"]').length&&""!==t&&($(".tag-input").before('\n            <li class="tag-item">\n                <p>'.concat(t,'</p>\n                <span class="tag-delete">×</span>\n                <input type="hidden" name="tag[]" value="').concat(t,'">\n            </li>')),e.trigger("focus"))}function c(t,e){$("#insert-link-name").val(t),$("#insert-link-url").val(e),a.modal()}function l(t,e){return 600<t?(e=600*e/t,t=600):800<e&&(t=800*t/e,e=800),{width:t,height:e}}function d(t,e,n){var i;n?($("#insert-pic-name").val(t),$("#insert-pic-url").val(e),$("#insert-pic-img").attr({src:e,width:n.width,height:n.height}),o.modal()):((i=new Image).src=e,i.complete?d(t,e,l(i.width,i.height)):i.onload=function(){d(t,e,l(i.width,i.height))})}$("#publish-date").datetimepicker({format:"Y-m-d H:i:s"}),$(window).on("beforeunload",function(t){if(r!==$('.post-form :input[name!="content"]').serialize())return t.returnValue="离开页面将丢失信息","离开页面将丢失信息！"}),$("#slug").on("input",function(){$("#slug-hide").text($(this).val())}),$("button[type='submit']").on("click",function(){$(window).off("beforeunload")}),$(document).on({mouseover:function(){$(this).addClass("active")},mouseout:function(){$(this).removeClass("active")},click:function(){s($(this).text())}},".list-group-item").on("click",".tag-delete",function(){$(this).parent().remove()}).on("click",'.file[title="删除"]',function(){var e=$(this).next(".attachment-id").val();confirm("是否删除所选的文件？")&&$.post("do.php?a=Admin/Attachment/Delete",{id:e},function(t){"ok"===t?$("#attachment-"+e).remove():alert(t)})}).on("click",".insert-file",function(){var t=$(this).text(),e=$(this).next(".attachment-url").val();($(this).hasClass("image")?d:c)(t,e)}),e.on("focus",function(){var t=$(".tag-option-list");$("#tag-input-dropdown").css({top:t.offset().top+t.outerHeight()+"px",left:t.offset().left+"px",width:t.outerWidth()+"px"}).show()}).on("blur",function(){setTimeout(function(){$("#tag-input-dropdown").hide()},100)}).on("keypress",function(t){var e;t.defaultPrevented||(void 0!==t.key?e=t.key:void 0!==t.keyIdentifier?e=t.keyIdentifier:void 0!==t.keyCode&&(e=t.keyCode),13!==e&&"Enter"!==e||(t.preventDefault(),s($(this).val())))}).on("input",function(){var t=this;clearTimeout(n),n=setTimeout(function(){$.getJSON("do.php?a=Admin/Tag/Search&search="+$(t).val(),function(t){var e=$("#tag-input-dropdown");e.html(""),t.forEach(function(t){e.append('<li class="list-group-item">'.concat(t,"</li>"))})})},500)}),i.addEventListener("drop",function(t){$(t.target).removeClass("drag"),upload.process(t.dataTransfer.files)},!1),i.addEventListener("dragleave",function(t){$(t.target).removeClass("drag")}),i.addEventListener("dragover",function(t){$(t.target).addClass("drag")}),i.addEventListener("click",function(){t.trigger("click")}),t.on("change",function(){upload.process(this.files),$(this).val("")}),document.addEventListener("dragleave",function(t){t.preventDefault()},!1),document.addEventListener("drop",function(t){t.preventDefault()},!1),document.addEventListener("dragenter",function(t){t.preventDefault()},!1),document.addEventListener("dragover",function(t){t.preventDefault()},!1),a.on("submit",function(){return addLinkToEditor($("#insert-link-name").val(),$("#insert-link-url").val()),a.modal("hide"),!1}),o.on("submit",function(){var t=$("#insert-pic-img"),e=t.width(),n=t.height();return 600<e?(n=600*n/e,e=600):800<n&&(e=800*e/n,n=800),addPicToEditor($("#insert-pic-name").val(),$("#insert-pic-url").val(),e,n),o.modal("hide"),!1}),$("#switch-insert-pic").on("click",function(){d($("#insert-link-name").val(),$("#insert-link-url").val())}),$("#switch-insert-link").on("click",function(){c($("#insert-pic-name").val(),$("#insert-pic-url").val())}),$("#visibility").on("change",function(){"password"===$(this).val()?$("#password").show():$("#password").hide()})});